// RevenuPros - Collection Management Platform
// Prisma Schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATIONS (Multi-tenant)
// ============================================

model Organization {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Business info
  businessName String
  industry     String? // "electrical", "hvac", "plumbing", etc.
  phone        String?
  email        String?
  website      String?
  timezone     String  @default("America/New_York") // For TCPA compliance

  // Branding (to personalize messages)
  logoUrl String?

  // Subscription & Billing
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  subscriptionStatus     String?   // "trialing", "active", "past_due", "canceled", "unpaid"
  subscriptionTier       String    @default("starter") // "starter", "pro", "business"
  billingPeriod          String    @default("monthly") // "monthly", "annual"
  subscriptionEndsAt     DateTime?
  trialEndsAt            DateTime?

  // Usage Tracking (Credits per billing cycle)
  smsCreditsUsed         Int       @default(0)
  emailCreditsUsed       Int       @default(0)
  smsCreditsLimit        Int       @default(100)    // Starter: 100, Pro: 500, Business: 2000
  emailCreditsLimit      Int       @default(200)    // Starter: 200, Pro: 1000, Business: 5000
  billingCycleStart      DateTime?
  billingCycleEnd        DateTime?

  // Feature Flags (tier-based)
  hasQuickBooksAccess    Boolean   @default(false)  // Pro+
  hasCustomBranding      Boolean   @default(false)  // Business only
  hasAdvancedAnalytics   Boolean   @default(false)  // Business only
  maxSequences           Int       @default(3)      // Starter: 3, Pro: 10, Business: unlimited (999)
  maxTeamMembers         Int       @default(1)      // Starter: 1, Pro: 5, Business: unlimited (999)

  // Settings
  settings Json @default("{}")

  // Payment Settings
  defaultPaymentUrl      String?  // Organization-level default payment link
  defaultPaymentMethod   String?  // "stripe", "custom_link", "manual_only"
  paymentInstructions    String?  // Default payment instructions

  // Onboarding & First-time Experience
  completedOnboarding    Boolean   @default(false)  // Has user completed initial onboarding
  hasSeenWelcome         Boolean   @default(false)  // Has user seen welcome modal
  hasSeenSequences       Boolean   @default(false)  // Has user seen sequences showcase after onboarding
  usedDemoData           Boolean   @default(false)  // Is using demo/sample data
  onboardingProgress     Json      @default("{}")   // Track checklist completion: {addedCustomer: true, createdInvoice: false, ...}

  // Dashboard Customization
  dashboardLayout        Json?                       // User's custom widget layouts per tab: {overview: [{id, x, y, w, h}], customers: [...]}
  widgetSettings         Json      @default("{}")   // Widget-specific settings: {stats: {expanded: true}, chart: {dateRange: '6m'}}

  // Collection & Communication Preferences (from onboarding questionnaire)
  collectionMethod       String?                    // "invoicing_software", "manual_invoices", "cash_only", "mixed"
  hasExistingInvoices    Boolean   @default(false)  // Has outstanding invoices
  preferredChannels      Json      @default("{}")   // {sms: true, email: true, phone: false}
  communicationTone      String?                    // "friendly", "professional", "firm", "casual"
  followUpFrequency      String?                    // "aggressive", "moderate", "relaxed"
  averageInvoiceAmount   Int?                       // In cents, helps AI calibrate messaging
  typicalPaymentTerms    Int       @default(30)     // Days (e.g., Net 30)

  // Business Metrics & State (for sequence tuning and lien flows)
  primaryState           String?                    // Two-letter state code (e.g., "CA", "TX") for lien law application
  invoicesPerYear        Int?                       // Volume metric: 1-50, 51-200, 201-500, 500+
  latePaymentsPerMonth   Int?                       // Delinquency metric: 0-5, 6-15, 16-30, 30+
  timeSpentChasing       Int?                       // Hours per week spent chasing invoices

  // Relations
  users              User[]
  customers          Customer[]
  invoices           Invoice[]
  messages           Message[]
  sequenceTemplates  SequenceTemplate[]
  auditLogs          AuditLog[]
  campaignEnrollments CampaignEnrollment[]

  @@index([stripeCustomerId])
}

// ============================================
// USERS (Team members)
// ============================================

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email         String   @unique
  name          String?
  role          String   @default("member") // "owner", "admin", "member"

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
}

// ============================================
// CUSTOMERS (Debtors)
// ============================================

model Customer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Contact info
  firstName   String
  lastName    String
  email       String?
  phone       String? // E.164 format
  address     String?
  city        String?
  state       String?
  zip         String?

  // Property info (for mechanics liens)
  propertyAddress     String?
  propertyCity        String?
  propertyState       String?
  propertyZip         String?

  // TCPA Compliance
  smsConsentGiven     Boolean   @default(false)
  smsConsentDate      DateTime?
  smsConsentMethod    String?   // "verbal", "written", "online_form"
  smsOptedOut         Boolean   @default(false)
  smsOptedOutAt       DateTime?
  emailConsentGiven   Boolean   @default(false)
  emailOptedOut       Boolean   @default(false)
  emailOptedOutAt     DateTime?

  // Customer metadata
  customerNotes       String?
  externalId          String?   // ID from their accounting system
  tags                String[]  @default([])

  // Relations
  invoices            Invoice[]
  messages            Message[]
  campaignEnrollments CampaignEnrollment[]
  scheduledMessages   ScheduledMessage[]

  @@unique([organizationId, externalId])
  @@index([organizationId])
  @@index([phone])
  @@index([email])
}

// ============================================
// INVOICES (Outstanding balances)
// ============================================

model Invoice {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Invoice details
  invoiceNumber   String
  invoiceDate     DateTime
  dueDate         DateTime
  description     String?

  // Amounts (in cents to avoid floating point issues)
  amountDue       Int      // Original amount
  amountPaid      Int      @default(0)
  amountRemaining Int      // Calculated field updated on payment
  currency        String   @default("usd")

  // Status
  status          String   @default("outstanding") // "outstanding", "partial", "paid", "written_off"
  daysPastDue     Int      @default(0) // Calculated daily

  // Collection tracking
  inCollection            Boolean   @default(false)
  collectionStartedAt     DateTime?
  collectionSequenceId    String?
  collectionSequence      SequenceTemplate? @relation(fields: [collectionSequenceId], references: [id])
  lastContactedAt         DateTime?
  nextScheduledContactAt  DateTime?
  contactAttempts         Int       @default(0)

  // Payment
  stripePaymentIntentId   String?
  stripePaymentLinkId     String?
  paidAt                  DateTime?

  // Custom Payment Options
  customPaymentUrl        String?  // User's own payment link for this invoice
  externalInvoiceRef      String?  // Reference to external system (QuickBooks, etc.)
  paymentInstructions     String?  // Custom payment instructions for this invoice

  // Mechanics Lien Tracking
  firstWorkDate           DateTime? // First date work was performed (for lien deadlines)
  lastWorkDate            DateTime?  // Last date work was performed (completion date)
  lienEligible            Boolean   @default(false) // Is this invoice eligible for mechanics lien
  preliminaryNoticeSent   Boolean   @default(false)
  preliminaryNoticeSentAt DateTime?
  lienFiled               Boolean   @default(false)
  lienFiledAt             DateTime?
  lienFilingReference     String?   // County filing number or reference

  // Relations
  messages            Message[]
  payments            Payment[]
  campaignEnrollments CampaignEnrollment[]
  scheduledMessages   ScheduledMessage[]
  noticeOfIntents     NoticeOfIntent[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amount              Int      // In cents
  currency            String   @default("usd")
  paymentMethod       String   // "credit_card", "ach", "check", "cash", "bank_transfer", "venmo", "zelle", "paypal", "other"
  paymentDate         DateTime @default(now()) // When payment was received
  referenceNumber     String?  // Check number, confirmation code, etc.
  stripePaymentId     String?  @unique
  stripeChargeId      String?
  status              String   @default("completed") // "pending", "completed", "failed", "refunded"
  notes               String?

  @@index([invoiceId])
  @@index([stripePaymentId])
}

// ============================================
// COLLECTION SEQUENCES (Templates)
// ============================================

model SequenceTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String
  description String?
  isActive    Boolean @default(true)
  isDefault   Boolean @default(false)

  // NEW: Sequence type
  sequenceType String @default("invoice") // "invoice" or "customer"

  // Source tracking
  source       String  @default("user_created") // "standard", "ai_generated", "user_created"

  // Lien-specific fields
  isLienSequence Boolean @default(false) // Is this a mechanic's lien protection sequence
  applicableStates String? // Comma-separated state codes (e.g., "CA,TX,FL") or null for all states

  // Trigger rules
  triggerDaysPastDue Int @default(0) // Start when X days past due

  // Relations
  steps       SequenceStep[]
  invoices    Invoice[]
  enrollments CampaignEnrollment[]

  @@index([organizationId])
  @@index([sequenceType])
}

model SequenceStep {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sequenceId String
  sequence   SequenceTemplate @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  stepNumber  Int      // Order in sequence
  delayDays   Int      // Days after previous step (or trigger for first step)
  channel     String   // "sms", "email"

  // Message content
  subject     String?  // For email
  body        String   // Template with variables: {{customerName}}, {{amountDue}}, {{paymentLink}}, etc.

  // Behavior
  isActive    Boolean  @default(true)

  @@unique([sequenceId, stepNumber])
  @@index([sequenceId])
}

// ============================================
// MESSAGES (Communication log)
// ============================================

model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  invoiceId  String?
  invoice    Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  // Message details
  channel     String   // "sms", "email"
  direction   String   // "outbound", "inbound"

  // Content
  subject     String?  // Email only
  body        String

  // Delivery tracking
  status      String   @default("pending") // "pending", "sent", "delivered", "failed", "bounced"
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  errorMessage String?

  // Provider IDs (for tracking)
  twilioSid   String?  @unique
  emailId     String?

  // Compliance & audit
  sentFromNumber String?  // Phone number used
  sentFromEmail  String?  // Email address used
  isAutomated    Boolean  @default(false)

  // Relations
  scheduledMessages ScheduledMessage[]

  @@index([organizationId])
  @@index([customerId])
  @@index([invoiceId])
  @@index([createdAt])
  @@index([twilioSid])
  @@index([organizationId, createdAt, id]) // Composite index for cursor-based pagination
  @@index([customerId, invoiceId]) // For filtering by customer + invoice
  @@index([channel, status]) // For filtering by channel and status
}

// ============================================
// AUDIT LOGS (Compliance)
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Event tracking
  action      String   // "sms_sent", "consent_given", "opt_out", "payment_received", etc.
  entityType  String?  // "customer", "invoice", "message"
  entityId    String?

  // Details
  metadata    Json     @default("{}")
  ipAddress   String?
  userAgent   String?
  userId      String?

  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// CAMPAIGN ENROLLMENTS (Supports Invoice & Customer modes)
// ============================================

model CampaignEnrollment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  sequenceId String
  sequence   SequenceTemplate @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // EITHER invoice OR customer (one must be set)
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Campaign metadata
  campaignId   String  // Group enrollments by campaign launch
  campaignName String? // User-friendly campaign name

  // Tracking
  status            String   @default("active") // "active", "paused", "completed", "cancelled", "stopped"
  enrolledAt        DateTime @default(now())
  currentStep       Int      @default(0)
  lastMessageSentAt DateTime?
  completedAt       DateTime?
  stoppedAt         DateTime?
  stoppedReason     String? // "paid", "manual_stop", "opt_out", "customer_request"

  // Relations
  scheduledMessages ScheduledMessage[]

  @@index([organizationId])
  @@index([sequenceId])
  @@index([invoiceId])
  @@index([customerId])
  @@index([campaignId])
  @@index([status])
  @@index([enrolledAt])
}

// ============================================
// SCHEDULED MESSAGES (Message Queue for Automation)
// ============================================

model ScheduledMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollmentId String
  enrollment   CampaignEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  sequenceStepId String
  // Note: Can't add SequenceStep relation here directly due to potential deletion
  // Store step data separately

  // Recipient info
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  // Scheduling
  scheduledFor DateTime
  sentAt       DateTime?
  processedAt  DateTime?

  // Message details
  channel String // "sms", "email"
  subject String? // Email only
  body    String // Filled template with variables replaced

  // Status tracking
  status       String  @default("pending") // "pending", "sent", "skipped_no_consent", "skipped_paid", "failed", "cancelled"
  failureCount Int     @default(0)
  errorMessage String?

  // Created message reference (after sending)
  messageId String?
  message   Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([customerId])
  @@index([invoiceId])
  @@index([scheduledFor, status])
  @@index([status])
  @@index([processedAt])
}

// ============================================
// NOTICE OF INTENT TO LIEN (NOI)
// ============================================

model NoticeOfIntent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Invoice reference
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // NOI Details
  noticeType        String   // "preliminary_notice", "notice_of_intent", "demand_letter"
  state             String   // State code (e.g., "CA", "TX") - determines legal requirements
  sentDate          DateTime // Date NOI was sent
  responseDeadline  DateTime // Date by which payment is required

  // Delivery tracking
  deliveryMethod    String   // "certified_mail", "hand_delivery", "email", "regular_mail"
  trackingNumber    String?  // USPS tracking number or similar
  deliveredAt       DateTime? // Actual delivery date (from tracking)
  deliveryStatus    String   @default("pending") // "pending", "delivered", "returned", "failed"

  // Recipients (some states require sending to multiple parties)
  recipients        Json     // Array of {name, address, recipientType: "owner" | "general_contractor" | "lender" | "tenant"}

  // Document & Proof
  pdfUrl            String?  // URL to generated PDF
  proofOfServiceUrl String?  // URL to proof of delivery (tracking screenshot, receipt)

  // Amounts (snapshot at time of sending)
  amountClaimed     Int      // Amount claimed in NOI (in cents)
  lateFees          Int      @default(0)
  filingCosts       Int      @default(0)
  totalAmount       Int      // Total including fees

  // Lien deadlines (calculated at creation)
  lienFilingDeadline DateTime // Last day to file lien (based on state law)
  daysUntilDeadline  Int      // Days remaining to file lien

  // Response tracking
  paymentReceived    Boolean  @default(false)
  paymentReceivedAt  DateTime?
  paymentAmount      Int?     // Amount paid in response to NOI
  disputeReceived    Boolean  @default(false)
  disputeNotes       String?

  // Metadata
  notes              String?  // Internal notes about this NOI
  generatedBy        String?  // User who generated the NOI

  @@index([invoiceId])
  @@index([sentDate])
  @@index([deliveryStatus])
  @@index([lienFilingDeadline])
}
